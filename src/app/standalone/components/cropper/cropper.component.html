<!-- @format -->

<ng-container>
	<!-- prettier-ignore-attribute (click) -->
	<dialog
		class="modal"
		#cropperDialogElement
		(keydown.escape)="$event.preventDefault(); onToggleCropper(false)"
		(click)="$event.target === $event.currentTarget ? onToggleCropper(false) : $event"
	>
		<div
			class="flex items-center justify-center w-full max-w-md"
			appWindow
			[appWindowTitle]="'Cropper'"
			[appWindowButtons]="['close']"
			(appWindowClose)="onToggleCropper(false)"
		>
			<div
				class="flex flex-col p-4"
				slot="content"
				[class.overflow-hidden]="!cropperIsReady"
				[class.gap-4]="cropperIsReady"
			>
				<!-- prettier-ignore -->
				<form
					class="flex flex-col gap-4"
					autocomplete="off"
					[formGroup]="imageForm"
					[ngClass]="{ 'hidden': cropperIsReady }"
				>
					<p class="alert" role="alert">
						<i
							class="fill-current text-info"
							appSvgIcon
							[appSvgIconIcon]="'info-circle'"
							[appSvgIconSquare]="'1.5em'"
						></i>
						<span class="block">
              Browse file or paste it from clipboard or URL
            </span>
					</p>
					<fieldset class="form-control" *ngIf="imageForm.get('url') as url">
						<label class="label" for="imageFormUrl">
							<div class="indicator">
								<span
									class="badge indicator-item badge-error w-max translate-x-full translate-y-0 text-xs"
									*ngIf="url.dirty && !!url.errors && imageForm.enabled"
									[ngSwitch]="true"
								>
									<ng-container *ngSwitchCase="!!url.errors.required"> Required </ng-container>
									<ng-container *ngSwitchCase="!!url.errors.pattern">
										Url does not correct
									</ng-container>
								</span>
								<span class="label-text mr-2">Image</span>
							</div>
						</label>
						<div class="flex items-center justify-between gap-4">
							<div class="relative w-full">
								<input
									class="input input-bordered input-md w-full !pr-12"
									id="imageFormUrl"
									type="text"
                  inputmode="none"
									aria-label="Url"
									formControlName="url"
									placeholder="Paste image from clipboard or URL"
									appInputOnlyPaste
									appInputTrimWhitespace
									[class.input-success]="url.value && url.valid"
									[class.input-error]="url.dirty && url.invalid"
                  (input)="onGetFileFromInternet($event)"
                  (paste)="onGetFileFromClipboard($event)"
								/>
								<button
									class="btn btn-circle btn-sm absolute top-2 right-2 fill-current"
									type="button"
									aria-label="Clear"
									appSvgIcon
									*ngIf="!!url.value.length"
									[class.btn-success]="url.valid"
									[class.btn-error]="url.dirty && url.invalid"
									[class.btn-ghost]="url.pristine && url.invalid"
									[disabled]="imageForm.disabled"
									[appSvgIconIcon]="'x'"
									[appSvgIconSquare]="'2em'"
									(click)="url.setValue('')"
								></button>
							</div>
							<input
								class="hidden"
								type="file"
								#imageFormFile
								[accept]="imageFormMime"
								(change)="onGetFileFromDevice($event)"
							/>
							<button
								class="btn-success btn-md btn-square btn fill-current p-3"
								type="button"
								aria-label="Browse"
								[class.btn-outline]="imageForm.enabled"
								[disabled]="imageForm.disabled"
								[ngSwitch]="imageForm.disabled && !cropperFile"
								(click)="imageFormFile.click()"
							>
								<span class="loading loading-spinner" *ngSwitchCase="true"></span>
								<i
									class="block"
									appSvgIcon
									*ngSwitchDefault
									[appSvgIconIcon]="'folder'"
									[appSvgIconSquare]="'1.75em'"
								>
								</i>
							</button>
						</div>
						<label class="label" for="imageFormUrl">
							<span class="label-text-alt">Accept only <span class="inline font-bold">{{ imageFormMimeComputed() }}</span> files</span>
						</label>
					</fieldset>
				</form>
				<div
					class="flex flex-col gap-4"
					[ngClass]="{ 'invisible opacity-0 !m-0 !h-0': !cropperIsReady }"
				>
					<div class="block -m-4" [class.cursor-not-allowed]="cropperImageForm.disabled">
						<image-cropper
							class="ngx-cropper aspect-square !p-4"
							*appPlatform="'browser'"
							[(transform)]="cropperImageTransform"
							[class.ngx-cropper-disabled]="cropperImageForm.disabled"
							[class.ngx-cropper-move-image]="cropperMoveImage"
							[class.ngx-cropper-maintain-aspect-ratio]="!!cropperAspectRatioActive"
							[imageFile]="cropperFile"
							[imageAltText]="'Image cropper'"
							[output]="'blob'"
							[format]="'png'"
							[aspectRatio]="cropperAspectRatioActive || 1"
							[maintainAspectRatio]="!!cropperAspectRatioActive"
							[containWithinAspectRatio]="true"
							[resizeToWidth]="cropperResizeToWidth"
							[resizeToHeight]="cropperResizeToHeight"
							[cropperMinWidth]="cropperMinWidth"
							[cropperMinHeight]="cropperMinHeight"
							[cropper]="cropperPosition"
							[roundCropper]="false"
							[alignImage]="'center'"
							[allowMoveImage]="cropperMoveImage"
							(imageCropped)="onCropperCropped($event)"
							(cropperReady)="onCropperReady($event)"
							(loadImageFailed)="onCropperFailed()"
						>
						</image-cropper>
					</div>
					<div class="flex items-start justify-between gap-4">
						<!-- prettier-ignore -->
						<div
							class="flex overflow-auto rounded-btn border border-base-content/20"
							[ngClass]="{ 'border-transparent bg-base-200 cursor-not-allowed': cropperImageForm.disabled }"
						>
							<ul
								class="menu rounded-btn menu-horizontal menu-md flex-nowrap border-none p-0"
								[ngClass]="{ 'pointer-events-none': cropperImageForm.disabled }"
							>
								<li class="inline-block" [class.disabled]="cropperImageForm.disabled">
									<button
										class="fill-current p-3"
										type="button"
										title="Move bounding box"
										aria-label="Move bounding box"
										appSvgIcon
										[disabled]="cropperImageForm.disabled"
										[appSvgIconIcon]="'bounding-box-circles'"
										[appSvgIconSquare]="'1.5725em'"
										[ngClass]="{ 'active': !cropperMoveImage && !cropperImageForm.disabled }"
										(click)="cropperMoveImage = false"
									></button>
								</li>
								<li class="inline-block" [class.disabled]="cropperImageForm.disabled">
									<button
										class="fill-current p-3"
										type="button"
										title="Move image"
										aria-label="Move image"
										appSvgIcon
										[disabled]="cropperImageForm.disabled"
										[appSvgIconIcon]="'arrows-move'"
										[appSvgIconSquare]="'1.5725em'"
										[ngClass]="{ 'active': cropperMoveImage && !cropperImageForm.disabled }"
										(click)="cropperMoveImage = true"
									></button>
								</li>
								<li class="inline-block" [class.disabled]="cropperImageForm.disabled">
									<button
										class="rotate-90 fill-current p-3"
										type="button"
										title="Mirror horizontal"
										aria-label="Mirror horizontal"
										appSvgIcon
										*ngIf="cropperImageForm.get('flipV') as flipV"
										[disabled]="cropperImageForm.disabled"
										[appSvgIconIcon]="'symmetry-vertical'"
										[appSvgIconSquare]="'1.5725em'"
										(click)="flipV.setValue(!flipV.value)"
									></button>
								</li>
								<li class="inline-block" [class.disabled]="cropperImageForm.disabled">
									<button
										class="fill-current p-3"
										type="button"
										title="Mirror vertical"
										aria-label="Mirror vertical"
										appSvgIcon
                    *ngIf="cropperImageForm.get('flipH') as flipH"
										[disabled]="cropperImageForm.disabled"
										[appSvgIconIcon]="'symmetry-vertical'"
										[appSvgIconSquare]="'1.5725em'"
                    (click)="flipH.setValue(!flipH.value)"
									></button>
								</li>
                <ng-container *ngIf="markdownItToggle">
                  <li class="inline-block" [class.disabled]="cropperImageForm.disabled">
                    <div
                      class="flex p-0"
                      appDropdown
                      *ngIf="{ value: false } as toggle"
                      [ngClass]="{ 'bg-base-content/10': toggle.value }"
                      [appDropdownPlacement]="'top-start'"
                      (appDropdownToggle)="toggle.value = $event"
                    >
                      <button
                        class="fill-current p-3"
                        type="button"
                        title="Aspect ratio"
                        aria-label="Aspect ratio"
                        appSvgIcon
                        slot="target"
                        [disabled]="cropperImageForm.disabled"
                        [appSvgIconIcon]="'aspect-ratio'"
                        [appSvgIconSquare]="'1.5725em'"
                      ></button>
                      <ul class="menu menu-vertical menu-md m-0" slot="content">
                        <li
                          class="flex w-full"
                          *ngFor="let cropperAspectRatio of cropperAspectRatioList"
                        >
                          <button
                            class="w-full whitespace-nowrap text-base-content"
                            type="button"
                            [class.active]="cropperAspectRatioActive === cropperAspectRatio.value"
                            [attr.aria-label]="cropperAspectRatio.label"
                            (click)="cropperAspectRatioActive = cropperAspectRatio.value"
                          >
                            {{ cropperAspectRatio.label }}
                          </button>
                        </li>
                      </ul>
                    </div>
                  </li>
                </ng-container>
                <li class="inline-block" [class.disabled]="cropperImageForm.disabled">
                  <div
                    class="flex p-0"
                    appDropdown
                    *ngIf="{ value: false } as toggle"
                    [ngClass]="{ 'bg-base-content/10': toggle.value }"
                    [appDropdownPlacement]="'top'"
                    [appDropdownClose]="false"
                    (appDropdownToggle)="toggle.value = $event"
                  >
                    <button
                      class="fill-current p-3"
                      type="button"
                      title="Rotate"
                      aria-label="Rotate"
                      appSvgIcon
                      slot="target"
                      [disabled]="cropperImageForm.disabled"
                      [appSvgIconIcon]="'arrow-clockwise'"
                      [appSvgIconSquare]="'1.5725em'"
                    ></button>
                    <div
                      class="min-w-80 sm:min-w-96 px-4"
                      slot="content"
                    >
                      <form
                        class="flex rounded-box cursor-default border border-base-content/20 bg-base-100 shadow w-full p-4"
                        autocomplete="off"
                        [formGroup]="cropperImageForm"
                      >
                        <fieldset class="form-control w-full" *ngIf="cropperImageForm.get('rotate') as rotate">
                          <label class="label w-full gap-4 p-0">
                            <span class="label-text">Rotate</span>
                            <input
                              class="range range-success flex-1"
                              type="range"
                              aria-label="Rotate"
                              formControlName="rotate"
                              [min]="0"
                              [max]="360"
                              [step]="5"
                              [value]="rotate.value"
                            />
                            <input
                              class="input-bordered input input-sm w-14 text-center"
                              type="number"
                              inputmode="numeric"
                              aria-label="Rotate"
                              formControlName="rotate"
                              [class.input-success]="rotate.valid"
                              [class.input-error]="rotate.invalid"
                              [value]="rotate.value"
                            />
                          </label>
                        </fieldset>
                      </form>
                    </div>
                  </div>
                </li>
                <li class="inline-block" [class.disabled]="cropperImageForm.disabled">
                  <div
                    class="flex p-0"
                    appDropdown
                    *ngIf="{ value: false } as toggle"
                    [ngClass]="{ 'bg-base-content/10': toggle.value }"
                    [appDropdownPlacement]="'top'"
                    [appDropdownClose]="false"
                    (appDropdownToggle)="toggle.value = $event"
                  >
                    <button
                      class="fill-current p-3"
                      type="button"
                      title="Zoom"
                      aria-label="Zoom"
                      appSvgIcon
                      slot="target"
                      [disabled]="cropperImageForm.disabled"
                      [appSvgIconIcon]="'zoom-in'"
                      [appSvgIconSquare]="'1.5725em'"
                    ></button>
                    <div
                      class="min-w-80 sm:min-w-96 px-4"
                      slot="content"
                    >
                      <form
                        class="flex rounded-box cursor-default border border-base-content/20 bg-base-100 shadow w-full p-4"
                        autocomplete="off"
                        [formGroup]="cropperImageForm"
                      >
                        <fieldset class="form-control w-full" *ngIf="cropperImageForm.get('scale') as scale">
                          <label class="label w-full gap-4 p-0">
                            <span class="label-text">Scale</span>
                            <input
                              class="range range-success flex-1"
                              type="range"
                              aria-label="Scale"
                              formControlName="scale"
                              [min]="1"
                              [max]="5"
                              [step]="0.1"
                              [value]="scale.value"
                            />
                            <input
                              class="input-bordered input input-sm w-14 text-center"
                              type="number"
                              inputmode="numeric"
                              aria-label="Scale"
                              formControlName="scale"
                              [class.input-success]="scale.valid"
                              [class.input-error]="scale.invalid"
                              [value]="scale.value"
                            />
                          </label>
                        </fieldset>
                      </form>
                    </div>
                  </div>
                </li>
							</ul>
						</div>
						<button
							class="btn-ghost w-12 h-12 btn-square btn bg-base-200 fill-current"
							type="button"
							title="Reset transform"
							aria-label="Reset transform"
							appSvgIcon
							[disabled]="cropperImageForm.disabled"
							[appSvgIconIcon]="'arrow-repeat'"
							[appSvgIconSquare]="'1.5em'"
							(click)="onCropperTransformReset()"
						></button>
					</div>
					<div class="flex flex-col gap-4">
						<button
							class="btn btn-success w-full"
							type="button"
							aria-label="Submit"
							[disabled]="cropperImageForm.disabled"
							(click)="onSubmitCropper()"
						>
							<span class="loading loading-spinner" *ngIf="cropperImageForm.disabled"></span>
							Submit
						</button>
						<button
							class="btn btn-error w-full"
							type="button"
							aria-label="Delete"
							[class.btn-outline]="cropperImageForm.enabled"
							[disabled]="cropperImageForm.disabled"
							(click)="onResetCropper()"
						>
							Delete
						</button>
					</div>
				</div>
			</div>
		</div>
	</dialog>
</ng-container>
