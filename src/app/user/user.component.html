<!-- @format -->

<ng-container>
	<div class="flex flex-col space-y-4 md:space-y-8">
		<header
			class="rounded-box flex flex-col items-start justify-start gap-4 border border-base-content/20 bg-base-100 p-4 shadow-xl"
		>
			<div class="flex w-full items-center justify-between gap-4">
				<div class="flex items-center justify-start gap-4 overflow-auto">
					<div
						class="flex h-12 min-h-[3rem] w-12 min-w-[3rem]"
						appAvatar
						[appUser]="user"
					></div>
					<div class="flex flex-col overflow-auto">
						<h1 class="truncate text-2xl font-bold text-base-content">
							{{ user.name }}
						</h1>
						<time
							class="truncate text-sm text-base-content/50"
							[attr.datetime]="user.createdAt | dayjs : 'format' : 'YYYY-M-D'"
						>
							registered {{ user.createdAt | dayjs : "fromX" }}
						</time>
					</div>
				</div>
				<div class="flex items-center justify-end gap-4">
					<a
						class="btn-primary btn"
						aria-label="Settings"
						*ngIf="authUser?.id === user.id"
						[routerLink]="['/settings']"
					>
						Settings
					</a>
				</div>
			</div>
			<article
				class="prose rounded-box w-full max-w-none overflow-auto bg-base-200 p-4"
				*ngIf="!!user.description"
				[innerHTML]="user.description | markdown | sanitizer : 'html'"
			></article>
		</header>
		<div class="flex flex-col">
			<nav class="block px-4">
				<ul
					class="tabs w-full translate-y-px flex-nowrap space-x-1 overflow-auto rounded-t-lg"
				>
					<!-- prettier-ignore -->
					<li
						class="tab tab-lifted tab-lg h-11 border border-b border-solid border-base-content/20 !px-0"
						[ngClass]="routerLinkActive.isActive || !category ? 'tab-active h-12 border-b-0 !border-base-content/20 pb-0 before:invisible after:invisible' : 'bg-base-200'"
					>
						<a
							class="block whitespace-nowrap px-4"
							aria-label="All"
							#routerLinkActive="routerLinkActive"
							[routerLink]="['.']"
							[routerLinkActive]="''"
							[routerLinkActiveOptions]="{ exact: true }"
						>
							All
						</a>
					</li>
					<!-- prettier-ignore -->
					<li
						class="tab tab-lifted tab-lg h-11 border border-b border-solid border-base-content/20 !px-0"
						*ngFor="let category of categoryList"
						[ngClass]="routerLinkActive.isActive ? 'tab-active h-12 border-b-0 !border-base-content/20 pb-0 before:invisible after:invisible' : 'bg-base-200'"
					>
						<a
							class="flex h-full items-center justify-center whitespace-nowrap px-4"
							appScrollIntoView
							#routerLinkActive="routerLinkActive"
							[appScrollActive]="routerLinkActive.isActive"
							[routerLink]="['./category', category.id]"
							[routerLinkActive]="''"
							[attr.aria-label]="category.name"
						>
							<span class="block truncate max-w-[192px]">{{ category.name }}</span>
						</a>
					</li>
				</ul>
			</nav>
			<section
				class="rounded-box border border-base-content/20 bg-base-100 p-4 shadow-xl"
			>
				<div
					class="mb-4 flex w-full flex-col items-stretch justify-between gap-4"
					*ngIf="!!category"
				>
					<div class="flex w-full items-center justify-between gap-4">
						<div class="flex items-center justify-start gap-4 overflow-hidden">
							<button
								class="btn-ghost btn bg-base-200 fill-current p-3"
								type="button"
								title="Category"
								aria-label="Category"
								appSvgIcon
								[appIcon]="'folder'"
								[appSquare]="'1.375rem'"
							></button>
							<div class="flex flex-col overflow-hidden">
								<h2 class="block truncate text-xl font-bold text-base-content">
									{{ category.name }}
								</h2>
								<!-- prettier-ignore -->
								<time
									class="text-sm text-base-content/50 truncate"
									[attr.datetime]="category.createdAt | dayjs: 'format':'YYYY-M-D'"
								>
									created {{ category.createdAt | dayjs: "fromX" }}
								</time>
							</div>
						</div>
						<button
							class="btn-primary btn focus:outline-0"
							aria-label="Edit"
							*ngIf="authUser?.id === user.id"
							(click)="onToggleCategoryEditForm(true)"
						>
							Edit
						</button>
					</div>
					<article
						class="prose rounded-box w-full max-w-none overflow-auto bg-base-200 p-4"
						*ngIf="!!category.description"
						[innerHTML]="category.description | markdown | sanitizer : 'html'"
					></article>
				</div>
				<div class="block">
					<router-outlet></router-outlet>
				</div>
			</section>
		</div>
	</div>
	<!-- prettier-ignore-attribute (click) -->
	<dialog
		class="modal"
		#categoryEditFormModal
		(close)="onToggleCategoryEditForm(false)"
		(click)="$event.target === $event.currentTarget ? categoryEditFormModal.close() : $event"
	>
		<app-window
			[appTitle]="'Category'"
			(closed)="onToggleCategoryEditForm(false)"
		>
			<ng-container slot="content">
				<form
					class="flex w-window max-w-[512px] flex-col gap-4 p-4"
					autocomplete="off"
					slot="content"
					[formGroup]="categoryEditForm"
					(ngSubmit)="onSubmitCategoryEditForm()"
				>
					<fieldset
						class="form-control"
						*ngIf="categoryEditForm.get('name') as name"
					>
						<label class="label" for="categoryEditFormName">
							<div class="indicator">
								<!-- prettier-ignore -->
								<span
                  class="badge-error badge indicator-item w-max translate-x-full translate-y-0 text-xs"
                  *ngIf="name.touched && !!name.errors && categoryEditForm.enabled"
                  [ngSwitch]="true"
                >
                  <ng-container *ngSwitchCase="!!name.errors.required">
                    Required
                  </ng-container>
                  <ng-container *ngSwitchCase="!!name.errors.minlength">
                    Min length {{ name.errors.minlength["requiredLength"] }} characters
                  </ng-container>
                  <ng-container *ngSwitchCase="!!name.errors.maxlength">
                    Max length {{ name.errors.maxlength["requiredLength"] }} characters
                  </ng-container>
                </span>
								<span class="label-text mr-2">Name</span>
							</div>
						</label>
						<!-- prettier-ignore -->
						<div class="relative">
              <input
                class="input input-bordered w-full truncate pr-12"
                id="categoryEditFormName"
                type="text"
                aria-label="Name"
                formControlName="name"
                placeholder="Type category name"
                appInputTrimWhitespace
                [class.input-success]="name.touched && name.valid"
                [class.input-error]="name.touched && name.invalid"
              />
              <button
                class="btn btn-circle btn-sm absolute top-2 right-2 fill-current"
                type="button"
                aria-label="Clear"
                appSvgIcon
                *ngIf="!!name.value.length"
                [class.btn-success]="name.touched && name.valid"
                [class.btn-error]="name.touched && name.invalid"
                [class.btn-ghost]="name.untouched"
                [disabled]="categoryEditForm.disabled"
                [appIcon]="'x'"
                [appSquare]="'1.75rem'"
                (click)="name.setValue('')"
              ></button>
            </div>
					</fieldset>
					<fieldset
						class="form-control"
						*ngIf="categoryEditForm.get('description') as description"
					>
						<label class="label" for="categoryEditFormDescription">
							<!-- prettier-ignore -->
							<div class="indicator">
                <span
                  class="badge-error badge indicator-item w-max translate-x-full translate-y-0 text-xs"
                  *ngIf="!!description.value && !!description.errors && categoryEditForm.enabled"
                  [ngSwitch]="true"
                >
                  <ng-container *ngSwitchCase="!!description.errors.maxlength">
                    Max length {{ description.errors.maxlength["requiredLength"] }} characters
                  </ng-container>
                </span>
                <span
                  class="badge indicator-item w-max translate-x-full translate-y-0 text-xs"
                  *ngIf="!description.errors"
                  [class.badge-ghost]="!description.value"
                  [class.badge-success]="!!description.value && categoryEditForm.enabled"
                  [class.opacity-25]="categoryEditForm.disabled"
                >
                  Optional
                </span>
                <span class="label-text mr-2">Description</span>
              </div>
							<!-- prettier-ignore -->
							<span
                class="label-text-alt"
                [class.text-base-content]="categoryEditForm.disabled"
                [class.text-success]="categoryEditForm.enabled && !!description.value && description.valid"
                [class.text-error]="categoryEditForm.enabled && !!description.value && description.invalid"
              >
                {{ description.value?.length || 0 }}/255
              </span>
						</label>
						<!-- prettier-ignore -->
						<div
              class="rounded-btn flex overflow-hidden w-full border"
              [ngClass]="{ 'border-base-content/20': categoryEditForm.enabled, 'border-transparent': categoryEditForm.disabled }"
              [class.border-success]="!!description.value && description.valid"
              [class.border-error]="!!description.value && description.invalid"
            >
              <textarea
                class="textarea border-0 !outline-0 w-full resize-none"
                id="categoryEditFormDescription"
                aria-label="Description"
                placeholder="Type category description"
                formControlName="description"
                appInputTrimWhitespace
                [rows]="4"
              >
                {{ description.value }}
              </textarea>
            </div>
					</fieldset>
					<!-- prettier-ignore -->
					<fieldset class="form-control gap-4">
            <button
              class="btn btn-success"
              type="submit"
              aria-label="Submit"
              [class.loading]="categoryEditForm.disabled && !categoryDeleteFormModal.open"
              [disabled]="categoryEditForm.invalid || categoryEditForm.disabled || categoryEditFormIsPristine"
            >
              Submit
            </button>
            <button
              class="btn btn-error"
              type="button"
              aria-label="Delete"
              [class.btn-outline]="categoryEditForm.enabled"
              [disabled]="categoryEditForm.disabled"
              (click)="onToggleCategoryDeleteForm(true)"
            >
              Delete
            </button>
          </fieldset>
				</form>
			</ng-container>
		</app-window>
	</dialog>
	<!-- prettier-ignore-attribute (click) -->
	<dialog
		class="modal"
		#categoryDeleteFormModal
		(close)="onToggleCategoryDeleteForm(false)"
		(click)="$event.target === $event.currentTarget ? categoryDeleteFormModal.close() : $event"
	>
		<app-window
			[appTitle]="'Confirmation'"
			(closed)="onToggleCategoryDeleteForm(false)"
		>
			<ng-container slot="content">
				<form
					class="flex w-window max-w-[448px] flex-col gap-4 p-4"
					autocomplete="off"
					slot="content"
					[formGroup]="categoryDeleteForm"
					(ngSubmit)="onSubmitCategoryDeleteForm()"
				>
					<p class="alert inline">
						Are you sure you want to delete this category?
						<span class="underline">This action cannot be undone</span>
					</p>
					<fieldset
						class="form-control"
						*ngIf="categoryDeleteForm.get('name') as name"
					>
						<label class="label" for="categoryDeleteFormName">
							<div class="indicator">
								<!-- prettier-ignore -->
								<span
                  class="badge-error badge indicator-item w-max translate-x-full translate-y-0 text-xs"
                  *ngIf="name.touched && !!name.errors && categoryDeleteForm.enabled"
                  [ngSwitch]="true"
                >
                  <ng-container *ngSwitchCase="!!name.errors.required">
                    Required
                  </ng-container>
                  <ng-container *ngSwitchCase="!!name.errors.pattern">
                    Incorrect name
                  </ng-container>
                </span>
								<span class="label-text mr-2">
									Please type
									<span class="font-bold">{{ category?.name }}</span>
									to confirm
								</span>
							</div>
						</label>
						<div class="relative">
							<input
								class="input-bordered input w-full truncate pr-12"
								id="categoryDeleteFormName"
								type="text"
								aria-label="Name"
								formControlName="name"
								placeholder="Type category name"
								appInputTrimWhitespace
								[class.input-success]="name.dirty && name.valid"
								[class.input-error]="name.touched && name.invalid"
							/>
							<button
								class="btn-sm btn-circle btn absolute right-2 top-2 fill-current"
								type="button"
								aria-label="Clear"
								appSvgIcon
								*ngIf="!!name.value.length"
								[class.btn-success]="name.dirty && name.value"
								[class.btn-error]="name.touched && name.invalid"
								[class.btn-ghost]="name.untouched && name.dirty && name.invalid"
								[disabled]="categoryDeleteForm.disabled"
								[appIcon]="'x'"
								[appSquare]="'1.75rem'"
								(click)="name.setValue('')"
							></button>
						</div>
					</fieldset>
					<ng-container *ngIf="postList.length && categoryList.length > 1">
						<fieldset
							class="form-control"
							*ngIf="categoryDeleteForm.get('categoryId') as categoryId"
						>
							<label class="label">
								<!-- prettier-ignore -->
								<div class="indicator">
                  <span class="label-text mr-2">
                    Move category posts to another category
                  </span>
                  <span
                    class="badge indicator-item w-max translate-x-full translate-y-0 text-xs"
                    *ngIf="!categoryId.errors"
                    [class.badge-ghost]="!categoryId.value"
                    [class.badge-success]="!!categoryId.value && categoryDeleteForm.enabled"
                    [class.opacity-25]="categoryDeleteForm.disabled"
                  >
                  Optional
                </span>
                </div>
							</label>
							<!-- prettier-ignore -->
							<div
                class="menu rounded-btn mt-2 overflow-hidden border border-base-content/20 bg-base-100"
                slot="content"
                [class.border-success]="categoryId.value && categoryDeleteForm.enabled"
              >
                <ul
                  class="flex max-h-52 flex-col flex-nowrap overflow-y-auto p-2"
                  *ngIf="category as categoryActive"
                  [class.cursor-not-allowed]="categoryDeleteForm.disabled"
                >
                  <ng-container *ngFor="let category of categoryList">
                    <li
                      *ngIf="category.id !== categoryActive.id"
                      [ngClass]="{ 'disabled pointer-events-none': categoryDeleteForm.disabled }"
                    >
                      <button
                        *ngIf="{ value: categoryId.value === category.id } as isActive"
                        class="rounded-btn block w-full truncate text-left active:bg-success active:text-success-content"
                        type="button"
                        [class.bg-success]="!!isActive.value && categoryDeleteForm.enabled"
                        [class.text-success-content]="!!isActive.value && categoryDeleteForm.enabled"
                        [class.bg-base-200]="!!isActive.value && categoryDeleteForm.disabled"
                        [class.text-base-content]="!!isActive.value && categoryDeleteForm.disabled"
                        [attr.aria-label]="category.name"
                        (click)="categoryId.patchValue(category.id)"
                      >
                        {{ category.name }}
                      </button>
                    </li>
                  </ng-container>
                </ul>
              </div>
						</fieldset>
					</ng-container>
					<fieldset class="form-control">
						<!-- prettier-ignore -->
						<button
              class="btn btn-success"
              type="submit"
              aria-label="Submit"
              [class.loading]="categoryDeleteForm.disabled"
              [disabled]="categoryDeleteForm.invalid || categoryDeleteForm.disabled"
            >
              Submit
            </button>
					</fieldset>
				</form>
			</ng-container>
		</app-window>
	</dialog>
</ng-container>
