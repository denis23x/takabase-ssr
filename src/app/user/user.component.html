<!-- @format -->

<ng-container>
	<div class="flex flex-col space-y-4 md:space-y-8">
		<header
			class="rounded-box flex flex-col items-start justify-start gap-4 border border-base-content/20 bg-base-100 p-4 shadow-xl"
		>
			<div class="flex w-full items-center justify-between gap-4">
				<div class="flex items-center justify-start gap-4">
					<div class="flex w-12" appAvatar [appUser]="user"></div>
					<div class="flex flex-col">
						<span class="truncate text-xl font-bold text-base-content">
							{{ user.name }}
						</span>
						<time
							class="text-sm text-base-content/50"
							[attr.datetime]="user.createdAt | dayjs: 'format':'YYYY-M-D'"
						>
							registered {{ user.createdAt | dayjs: "fromX" }}
						</time>
					</div>
				</div>
				<div class="flex items-center justify-end gap-4">
					<a
						class="btn btn-primary"
						title="Settings"
						aria-label="Settings"
						*ngIf="authUser?.id === user.id"
						[routerLink]="['/settings']"
					>
						Settings
					</a>
				</div>
			</div>
			<p class="alert inline w-full">
				{{ user.description || "No description" }}
			</p>
		</header>
		<div class="flex flex-col">
			<nav class="block px-4">
				<ul
					class="tabs w-full translate-y-px flex-nowrap space-x-1 overflow-auto rounded-t-lg"
				>
					<!-- prettier-ignore -->
					<li
						class="tab tab-lifted tab-lg !px-0"
						[ngClass]="routerLinkActive.isActive || !category ? 'tab-active' : 'bg-base-200'"
					>
						<a
							class="block whitespace-nowrap px-4"
							aria-label="All"
							#routerLinkActive="routerLinkActive"
							[routerLink]="['.']"
							[routerLinkActive]="''"
							[routerLinkActiveOptions]="{ exact: true }"
						>
							All
						</a>
					</li>
					<li
						class="tab tab-lifted tab-lg !px-0"
						*ngFor="let category of categoryList"
						[ngClass]="routerLinkActive.isActive ? 'tab-active' : 'bg-base-200'"
					>
						<a
							class="flex h-full items-center justify-center whitespace-nowrap px-4"
							appScrollIntoView
							#routerLinkActive="routerLinkActive"
							[appScrollActive]="routerLinkActive.isActive"
							[routerLink]="['./category', category.id]"
							[routerLinkActive]="''"
							[attr.aria-label]="category.name"
						>
							{{ category.name }}
						</a>
					</li>
				</ul>
			</nav>
			<section
				class="rounded-box border border-base-content/20 bg-base-100 p-4 shadow-xl"
			>
				<div
					class="mb-4 flex w-full flex-col items-stretch justify-between gap-4"
					*ngIf="!!category"
				>
					<div class="flex w-full items-center justify-between gap-4">
						<div class="flex items-center justify-start gap-4">
							<button
								class="btn btn-ghost bg-base-200 fill-current p-3"
								type="button"
								title="Category"
								aria-label="Category"
								appSvgIcon
								[appIcon]="'folder'"
								[appSquare]="'1.375rem'"
							></button>
							<div class="flex flex-col">
								<span class="block truncate font-bold text-base-content">
									{{ category.name }}
								</span>
								<!-- prettier-ignore -->
								<time
									class="text-sm text-base-content/50"
									[attr.datetime]="category.createdAt | dayjs: 'format':'YYYY-M-D'"
								>
									created {{ category.createdAt | dayjs: "fromX" }}
								</time>
							</div>
						</div>
						<button
							class="btn btn-primary"
							title="Edit"
							aria-label="Edit"
							*ngIf="authUser?.id === user.id"
							(click)="onToggleCategoryEditForm(true)"
						>
							Edit
						</button>
					</div>
					<p class="alert inline w-full">
						{{ category.description }}
					</p>
				</div>
				<router-outlet></router-outlet>
			</section>
		</div>
	</div>
	<app-overlay
		[appToggle]="categoryEditFormToggle"
		(clicked)="onToggleCategoryEditForm(false)"
		(escaped)="onToggleCategoryEditForm(false)"
	>
		<app-window
			slot="content"
			[appTitle]="'Category'"
			(closed)="onToggleCategoryEditForm(false)"
		>
			<ng-container slot="content">
				<form
					class="flex w-window max-w-[512px] flex-col p-4"
					autocomplete="off"
					slot="content"
					[formGroup]="categoryEditForm"
					(ngSubmit)="onSubmitCategoryEditForm()"
				>
					<fieldset
						class="flex flex-col space-y-4"
						[disabled]="categoryEditFormIsSubmitted || categoryDeleteFormToggle"
					>
						<fieldset
							class="form-control"
							*ngIf="categoryEditForm.get('name') as name"
						>
							<label class="label" for="categoryEditFormName">
								<div class="indicator">
									<span
										class="badge indicator-item badge-error w-max translate-x-full translate-y-0 text-xs"
										*ngIf="name.touched && !!name.errors"
										[ngSwitch]="true"
									>
										<ng-container *ngSwitchCase="!!name.errors.required">
											Required
										</ng-container>
										<!-- prettier-ignore -->
										<ng-container *ngSwitchCase="!!name.errors.minlength">
											Min length {{ name.errors.minlength["requiredLength"] }} characters
                    </ng-container>
										<!-- prettier-ignore -->
										<ng-container *ngSwitchCase="!!name.errors.maxlength">
											Max length {{ name.errors.maxlength["requiredLength"] }} characters
                    </ng-container>
									</span>
									<span class="label-text mr-2">Name</span>
								</div>
							</label>
							<!-- prettier-ignore -->
							<div class="relative">
								<input
									class="input input-bordered w-full truncate pr-12"
									id="categoryEditFormName"
									type="text"
									aria-label="Name"
									formControlName="name"
									placeholder="Type category name"
									appInputTrimWhitespace
									[class.input-success]="name.touched && name.valid"
									[class.input-error]="name.touched && name.invalid"
									[class.input-disabled]="categoryEditFormIsSubmitted || categoryDeleteFormToggle"
								/>
								<button
									class="btn btn-circle btn-sm absolute top-2 right-2 fill-current"
									type="button"
									title="Clear"
									aria-label="Clear"
									appSvgIcon
									*ngIf="!!name.value.length"
									[class.btn-success]="name.touched && name.valid"
									[class.btn-error]="name.touched && name.invalid"
									[class.btn-ghost]="name.untouched"
									[class.btn-disabled]="categoryEditFormIsSubmitted || categoryDeleteFormToggle"
									[appIcon]="'x'"
									[appSquare]="'1.75rem'"
									(click)="name.setValue('')"
								></button>
							</div>
						</fieldset>
						<fieldset
							class="form-control"
							*ngIf="categoryEditForm.get('description') as description"
						>
							<label class="label" for="categoryEditFormDescription">
								<div class="indicator">
									<span
										class="badge indicator-item badge-error w-max translate-x-full translate-y-0 text-xs"
										*ngIf="description.touched && !!description.errors"
										[ngSwitch]="true"
									>
										<ng-container *ngSwitchCase="!!description.errors.required">
											Required
										</ng-container>
										<!-- prettier-ignore -->
										<ng-container *ngSwitchCase="!!description.errors.minlength">
                      Min length {{ description.errors.minlength["requiredLength"] }} characters
                    </ng-container>
										<!-- prettier-ignore -->
										<ng-container *ngSwitchCase="!!description.errors.maxlength">
                      Max length {{ description.errors.maxlength["requiredLength"] }} characters
                    </ng-container>
									</span>
									<span class="label-text mr-2">Description</span>
								</div>
								<!-- prettier-ignore -->
								<span
                  class="label-text-alt"
                  [class.text-base-content]="categoryEditFormIsSubmitted || categoryDeleteFormToggle"
                  [class.text-success]="!categoryEditFormIsSubmitted && !categoryDeleteFormToggle && description.touched && !description.errors"
                  [class.text-error]="!categoryEditFormIsSubmitted && !categoryDeleteFormToggle && description.touched && !!description.errors"
                >
                  {{ description.value.length }}/255
                </span>
							</label>
							<!-- prettier-ignore -->
							<textarea
                class="textarea textarea-bordered w-full"
                id="categoryEditFormDescription"
                aria-label="Description"
                placeholder="Type category description"
                formControlName="description"
                [rows]="4"
                [class.textarea-success]="description.touched && !description.errors"
                [class.textarea-error]="description.touched && !!description.errors"
                [class.textarea-disabled]="categoryEditFormIsSubmitted || categoryDeleteFormToggle"
              >
                {{ description.value }}
              </textarea>
						</fieldset>
						<!-- prettier-ignore -->
						<fieldset class="form-control gap-4">
							<button
								class="btn btn-success"
								type="submit"
								aria-label="Submit"
								[class.loading]="categoryEditFormIsSubmitted"
								[disabled]="categoryEditForm.invalid || categoryEditFormIsSubmitted || categoryEditFormIsPristine || categoryDeleteFormToggle"
							>
								Submit
							</button>
							<button
								class="btn btn-error"
								type="button"
								title="Delete"
								aria-label="Delete"
								[class.btn-outline]="!categoryEditFormIsSubmitted && !categoryDeleteFormToggle"
								[disabled]="categoryEditFormIsSubmitted || categoryDeleteFormToggle"
								(click)="onToggleCategoryDeleteForm(true)"
							>
								Delete
							</button>
						</fieldset>
					</fieldset>
				</form>
			</ng-container>
		</app-window>
	</app-overlay>
	<app-overlay
		[appToggle]="categoryDeleteFormToggle"
		(clicked)="onToggleCategoryDeleteForm(false)"
		(escaped)="onToggleCategoryDeleteForm(false)"
	>
		<app-window
			slot="content"
			[appTitle]="'Confirmation'"
			(closed)="onToggleCategoryDeleteForm(false)"
		>
			<ng-container slot="content">
				<form
					class="flex w-window max-w-[448px] flex-col space-y-4 p-4"
					autocomplete="off"
					slot="content"
					[formGroup]="categoryDeleteForm"
					(ngSubmit)="onSubmitCategoryDeleteForm()"
				>
					<p class="alert inline">This action cannot be undone.</p>
					<fieldset
						class="flex flex-col space-y-4"
						[disabled]="categoryDeleteFormIsSubmitted"
					>
						<fieldset
							class="form-control"
							*ngIf="categoryDeleteForm.get('name') as name"
						>
							<label class="label" for="categoryDeleteFormName">
								<div class="indicator">
									<span
										class="badge indicator-item badge-error w-max translate-x-full translate-y-0 text-xs"
										*ngIf="name.touched && !!name.errors"
										[ngSwitch]="true"
									>
										<ng-container *ngSwitchCase="!!name.errors.required">
											Required
										</ng-container>
										<ng-container *ngSwitchCase="!!name.errors.pattern">
											Incorrect name
										</ng-container>
									</span>
									<span class="label-text mr-2">
										Please type
										<span class="font-bold">{{ category?.name }}</span>
										to confirm
									</span>
								</div>
							</label>
							<div class="relative">
								<input
									class="input input-bordered w-full truncate pr-12"
									id="categoryDeleteFormName"
									type="text"
									aria-label="Name"
									formControlName="name"
									placeholder="Type category name"
									appInputTrimWhitespace
									[class.input-success]="name.touched && name.valid"
									[class.input-error]="name.touched && name.invalid"
									[class.input-disabled]="categoryDeleteFormIsSubmitted"
								/>
								<button
									class="btn btn-circle btn-sm absolute top-2 right-2 fill-current"
									type="button"
									title="Clear"
									aria-label="Clear"
									appSvgIcon
									*ngIf="!!name.value.length"
									[class.btn-success]="name.touched && name.valid"
									[class.btn-error]="name.touched && name.invalid"
									[class.btn-ghost]="name.untouched"
									[class.btn-disabled]="categoryDeleteFormIsSubmitted"
									[appIcon]="'x'"
									[appSquare]="'1.75rem'"
									(click)="name.setValue('')"
								></button>
							</div>
						</fieldset>
						<ng-container *ngIf="postList.length && categoryList.length > 1">
							<fieldset
								class="form-control"
								*ngIf="categoryDeleteForm.get('categoryId') as categoryId"
							>
								<label class="label">
									<div class="indicator">
										<span class="label-text mr-2">
											Move category posts to another category
										</span>
										<span
											class="badge indicator-item badge-success w-max translate-x-full translate-y-0 text-xs"
										>
											Optional
										</span>
									</div>
								</label>
								<div
									class="menu rounded-btn mt-2 overflow-hidden border border-base-content/20 bg-base-100 shadow"
									slot="content"
									[class.border-success]="categoryId.value"
								>
									<ul
										class="flex max-h-64 flex-col flex-nowrap overflow-y-auto p-2"
										*ngIf="category as categoryActive"
									>
										<ng-container *ngFor="let category of categoryList">
											<li *ngIf="category.id !== categoryActive.id">
												<!-- prettier-ignore -->
												<button
                          class="rounded-btn block w-full truncate text-left active:bg-success active:text-success-content"
                          type="button"
                          [ngClass]="{ 'bg-success text-success-content': categoryId.value === category.id && !categoryDeleteFormIsSubmitted }"
                          [attr.aria-label]="category.name"
                          (click)="categoryId.patchValue(category.id)"
                        >
                          {{ category.name }}
                        </button>
											</li>
										</ng-container>
									</ul>
								</div>
							</fieldset>
						</ng-container>
						<fieldset
							class="form-control"
							*ngIf="categoryDeleteForm.get('categoryId') as categoryId"
						>
							<!-- prettier-ignore -->
							<button
								class="btn"
                [ngClass]="!!categoryId.value ? 'btn-success' : 'btn-error'"
								type="submit"
								title="Submit"
								aria-label="Submit"
								[class.loading]="categoryDeleteFormIsSubmitted"
								[disabled]="categoryDeleteForm.invalid || categoryDeleteFormIsSubmitted"
							>
								Submit
							</button>
						</fieldset>
					</fieldset>
				</form>
			</ng-container>
		</app-window>
	</app-overlay>
</ng-container>
