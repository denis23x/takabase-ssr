<!-- @format -->

<ng-container>
	<div class="rounded-box border border-base-content/20 bg-base-100 p-4 flex flex-col gap-4 shadow-xl">
		<div class="flex w-full items-center justify-between gap-4">
			<button
				class="btn-ghost btn-md btn-square btn bg-base-200 fill-current"
				type="button"
				appSvgIcon
				appSkeleton
				[title]="postListSearchFormToggle ? 'Hide' : 'Search'"
				[attr.aria-label]="postListSearchFormToggle ? 'Hide' : 'Search'"
				[disabled]="postListSkeletonToggle"
				[appSkeletonToggle]="(categorySkeletonToggle || postListSkeletonToggle) && !postListSearchFormToggle"
				[appSkeletonClassListElementRef]="['border-0']"
				[appSvgIconIcon]="postListSearchFormToggle ? 'x-lg' : 'search'"
				[appSvgIconSquare]="'1.5em'"
				(click)="onToggleSearchForm(!postListSearchFormToggle)"
			></button>
			@switch (postListSearchFormToggle) {
				@case (true) {
					<div
						class="relative flex items-end justify-between gap-4 w-full"
						appSearchForm
						[appSearchFormDisabled]="postListSkeletonToggle"
					></div>
				}
				@case (false) {
					<div class="flex items-center justify-start gap-4 overflow-hidden w-full">
						<div class="flex flex-col gap-2 items-start overflow-hidden w-full">
							<h2
								class="block truncate text-xl leading-6 font-bold text-base-content max-w-full"
								appSkeleton
								[appSkeletonToggle]="categorySkeletonToggle || postListSkeletonToggle"
							>
								{{ category?.name }}
							</h2>
							<time
								class="text-sm text-base-content/50 leading-4 truncate max-w-full"
								appSkeleton
								[appSkeletonToggle]="categorySkeletonToggle || postListSkeletonToggle"
								[attr.datetime]="category?.updatedAt | dayjs: 'format' : 'YYYY-M-D'"
							>
								Updated {{ category?.updatedAt | dayjs: "fromX" }}
							</time>
						</div>
						<div
							class="flex p-0"
							appDropdown
							appSkeleton
							[appSkeletonToggle]="categorySkeletonToggle || currentUserSkeletonToggle || postListSkeletonToggle"
							[appDropdownPlacement]="'bottom-end'"
						>
							<button
								class="btn-ghost btn-md btn-square btn bg-base-200 fill-current"
								type="button"
								title="Category menu"
								aria-label="Category menu"
								appSvgIcon
								slot="target"
								[appSvgIconIcon]="'three-dots-vertical'"
								[appSvgIconSquare]="'1.5em'"
							></button>
							<ul class="menu menu-vertical menu-md" slot="content">
								@switch (true) {
									@case (currentUser?.id === user?.id) {
										<li class="flex w-full snap-start scroll-my-2 menu-title text-right text-xs">Category</li>
										<li class="flex w-full snap-start scroll-my-2">
											<button
												class="rounded-btn block w-full truncate text-right"
												type="button"
												title="Create new category"
												aria-label="Create new category"
												(click)="appCategoryCreateComponent?.onToggleCategoryCreateDialog(true)"
											>
												Create
											</button>
										</li>
										<li class="flex w-full snap-start scroll-my-2">
											<button
												class="rounded-btn block w-full truncate text-right"
												type="button"
												title="Update category"
												aria-label="Update category"
												(click)="appCategoryUpdateComponent?.onToggleCategoryUpdateDialog(true)"
											>
												Update
											</button>
										</li>
										<li class="flex w-full snap-start scroll-my-2">
											<button
												class="rounded-btn block w-full truncate text-right"
												type="button"
												title="Delete category"
												aria-label="Delete category"
												(click)="appCategoryDeleteComponent?.onToggleCategoryDeleteDialog(true)"
											>
												Delete
											</button>
										</li>
									}
									@case (currentUser?.id !== user?.id) {
										<li class="flex w-full snap-start scroll-my-2">
											<button
												class="rounded-btn block w-full truncate text-right"
												type="button"
												title="Work In Progress"
												aria-label="Work In Progress"
											>
												WIP
											</button>
										</li>
									}
								}
							</ul>
						</div>
					</div>
				}
			}
		</div>
		@if (category?.description) {
			<div
				class="block"
				appSkeleton
				[appSkeletonToggle]="categorySkeletonToggle || postListSkeletonToggle"
				[appSkeletonClassListParent]="['!rounded-box']"
				[appSkeletonClassList]="['!rounded-box']"
			>
				<article
					class="prose rounded-box w-full max-w-none overflow-auto bg-base-200 p-4"
					[innerHTML]="category?.description | markdown | sanitizer: 'html'"
				></article>
			</div>
		}
		<div class="block">
			<ul class="grid grid-cols-2 grid-rows-none gap-4 sm:grid-cols-3 md:grid-cols-4">
				@for (post of postList; track i; let i = $index) {
					<li
						class="block"
						appCardPost
						[ngClass]="post.image ? 'row-span-6' : 'row-span-3'"
						[appCardPostPost]="post"
						[appCardPostSkeletonToggle]="postListSkeletonToggle"
						[appPostUrl]="'./post'"
					></li>
				} @empty {
					<li class="col-span-2 sm:col-span-3 md:col-span-4 flex flex-col items-center gap-4">
						<i
							class="fill-current text-base-content"
							appSvgIcon
							[appSvgIconIcon]="'exclamation-circle'"
							[appSvgIconSquare]="'3em'"
						></i>
						<div class="text-center">
							<p class="text-xl font-bold text-base-content">Posts <span class="text-error">not found</span></p>
							<a class="link text-sm" title="Create post" aria-label="Create post" [routerLink]="['/create']">
								Create post
							</a>
						</div>
					</li>
				}
			</ul>
			@if (postListIsHasMore && !postListPageScrollInfinite) {
				<button
					class="btn-md btn-success btn mt-4 w-full"
					type="button"
					title="Load more posts"
					aria-label="Load more posts"
					[disabled]="postListIsLoading()"
					(click)="getPostList(true)"
				>
					@if (postListIsLoading()) {
						<span class="loading loading-spinner"></span>
					}
					Load more
				</button>
			}
		</div>
	</div>
	<div class="block">
		<router-outlet></router-outlet>
	</div>
	<!-- prettier-ignore -->
	@defer (when currentUser?.id === user?.id; prefetch on idle) {
		<div
      appCategoryCreate
      #appCategoryCreateComponent
      (appCategoryCreateSuccess)="onCreateCategory($event)">
    </div>
		<div
			appCategoryUpdate
			#appCategoryUpdateComponent
			[appCategoryUpdateCategory]="category"
			(appCategoryUpdateSuccess)="onUpdateCategory($event)"
		></div>
		<div
			appCategoryDelete
			#appCategoryDeleteComponent
			[appCategoryDeleteCategory]="category"
			[appCategoryDeleteCategoryPostList]="postList"
			(appCategoryDeleteSuccess)="onDeleteCategory($event)"
		></div>
	}
</ng-container>
